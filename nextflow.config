// Please do not change the order of the numbered sections!
// The expected order is: 1. Parameters - 2. Profiles - 3. Process -  4. Executor

// There is a high chance it would break the configuration of 'profiles'

// 1. Parameters

// NOTE: 
// Initialise the values of the params to the preferred default value or to false
params {
    // input options
    input = false
    outdir = 'results'
    // options cram/bam (copes with upper/lower)
    format = 'bam'
    // reference file base
    genome_fasta = false
    bp_in_batch = 100000000

    // report_dir is:
    // - the folder from the container that includes the scripts for NF <= v20.01 (bin)
    // - the ${projectDir}/bin folder of the root of the repo with the scripts for NF >= v20.10
    report_dir = '/opt/bin/'

    // when set to true, prints help and exits
    help = false

    // container for all processes, excluding those defined with 'withName' (see example below)
    container = 'quay.io/lifebitai/ubuntu:18.10'

    // process resources defaults
    cpus = 1
    memory = 2.GB
    disk = '30.GB'
    
    // max resources limits defaults
    max_cpus = 2
    max_memory = 4.GB
    max_time = 8.h
    
    // execution related defaults
    config = 'conf/standard.config'
    echo = false
    errorStrategy = 'finish'
    maxRetries = 9
    maxForks = 200
    queueSize = 200
    executor = false

    // google-lifesciences
    gls_bootDiskSize = '50.GB'
    gls_preemptible = true
    zone = 'us-east1-b'
    network = 'default'
    subnetwork = 'default'
}

// 2. Profiles


// Do not update the order because the values set in params scope will not be overwritten
// Do not attempt to simplify to 
// includeConfig params.config 
// outside of profiles scope, it will fail to update the values of the params
profiles {
    standard {includeConfig params.config}
    docker { docker.enabled = true }
    singularity { includeConfig 'conf/singularity.config' }
    base {includeConfig 'conf/base.config'}
    google {includeConfig 'conf/google.config'}
    test {includeConfig 'conf/test.config'}
    local {includeConfig 'conf/test.config'}
}

// 3. Process

// Do not change order of block, must follow after profiles scope (last section that updates params)
process {
    echo = params.echo
    cpus = params.cpus
    memory = params.memory
    maxRetries = params.maxRetries
    maxForks = params.maxForks
    container = params.container
    errorStrategy = params.errorStrategy
  
    // If your pipeline doesn't include a process named 'step_1', update the name to match your process of choice or delete this block

    withName: bwamem {
        disk = '500.GB' // data dependent
        cpus = 32 // increase memory 1GB per extra thread >32.
        memory = '200.G' // minimum for 32
        time = '12h' // input dependent, 30x from fastq pair ~2h
        container = 'quay.io/cynapse-ccri/bwa-meme_bwakit@sha256:56230b8d984470887790b2252c519bcc70b61961565878341543afb434e59d5b'
        clusterOptions  = '-p skylake-himem'
    }

    withName: samtools_markdup {
        disk = '200.GB'
        cpus = 4
        memory = '4.G'
        time = '3h'
        container = 'quay.io/cynapse-ccri/bwa-meme_bwakit@sha256:56230b8d984470887790b2252c519bcc70b61961565878341543afb434e59d5b'
    }
}

// 4. Executor - Do not remove this section! Required for running with different executors using --executor parameter

executor {
    name = params.executor
    queueSize = params.queueSize
}

// for kr525

def trace_timestamp = new java.util.Date().format( 'yyyy-MM-dd_HH-mm-ss')
trace {
  enabled = true
  file = "${params.outdir}/execution_trace_${trace_timestamp}.txt"
}
// To allow DAG, Graphviz must be installed
/*
dag {
    enabled = true
    file    = "${params.outdir}/pipeline_dag_${trace_timestamp}.svg"
}
*/
timeline {
  enabled = true
  file = "${params.outdir}/execution_timeline_${trace_timestamp}.html"
}
report {
  enabled = true
  file = "${params.outdir}/execution_report_${trace_timestamp}.html"
}